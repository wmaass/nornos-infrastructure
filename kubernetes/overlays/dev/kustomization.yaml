apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: nornos

resources:
- ../../base

namePrefix: dev-

commonLabels:
  environment: dev

# Patches for dev environment
patches:
# Reduce replicas for dev
- patch: |-
    - op: replace
      path: /spec/replicas
      value: 1
  target:
    kind: Deployment
    name: ".*"

# Reduce resource limits
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/cpu
      value: 50m
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/memory
      value: 128Mi
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/cpu
      value: 200m
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/memory
      value: 256Mi
  target:
    kind: Deployment
    name: "patient-app|doctor-app"

# Dev-specific ConfigMaps
configMapGenerator:
- name: patient-app-config
  behavior: merge
  literals:
  - api-base-url=https://api.dev.nornos.io
  - auth-service-url=https://auth.dev.nornos.io

- name: agent-service-config
  behavior: merge
  literals:
  - relay-server-url=http://dev-relay-server
  - log-level=DEBUG

# Dev secrets (use sealed-secrets in practice)
secretGenerator:
- name: database-credentials
  literals:
  - url=postgresql://nornos:dev-password@dev-postgres:5432/nornos

- name: redis-credentials
  literals:
  - url=redis://dev-redis:6379/0

# Images for dev (use local or dev ECR)
images:
- name: nornos/patient-app
  newTag: dev
- name: nornos/doctor-app
  newTag: dev
- name: nornos/agent-service
  newTag: dev
- name: nornos/relay-server
  newTag: dev
- name: nornos/shared-data-server
  newTag: dev
- name: nornos/auth-service
  newTag: dev
- name: nornos/vault-server
  newTag: dev
